{% extends "base.html" %}
{% block title %}Start Game â€“ Bypeyes{% endblock %}

{% block content %}
<div class="centered-content">
  <div class="info-card" >
    <p>Each player has a secret word. Can you chat without the AI moderator guessing yours? Can you outsmart an AI?</p><br>
    <p>Every player gets a secret word, and you have to talk to other players without saying your word, but you can give tips that can help them understand you. Meanwhile, there's an AI moderator that's reading everything, and trying to guess your secret word from the words you send. So your job is to give good hints, but still trick the robot so it canâ€™t guess your secret word. If the AI guesses your word, you lose. If your friends guess it, you win.</p>
  </div>
  <h2>Start a Game</h2>
  
  {% if game_id %}
    <p>Player 1 has entered their secret word. Share the following link with Player 2 to join:</p>
    <div style="display: flex; flex-direction: column; align-items: start; gap: 0.5rem;">
      <input type="text" value="{{ player2_url }}" id="join-link" readonly style="width: 100%; font-size: 0.9rem;" />
      <button onclick="copyJoinLink()" style="background: var(--accent-color); color: white; font-weight: bold;">ğŸ“‹ Copy Link</button>
      <span id="copy-status" style="color: green; display: none;">Copied!</span>
    
      <!-- Check if Player 2 has joined -->
      <button onclick="checkPlayer2()" style="margin-top: 1rem; background: var(--primary-color); color: white; font-weight: bold;">ğŸ” Check if Player 2 Joined</button>
      <span id="join-status" style="margin-top: 0.5rem;"></span>
    </div>      
    </div>    
    <p>Player 2 will enter their secret word once they click the link.</p>
{% else %}
    <form method="post" action="{{ url_for('start') }}">
       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input name="secret" placeholder="Your secret English word" required pattern="[A-Za-z]{3,}">
        <button type="submit">Play</button>
    </form>
{% endif %}

  {% if error %}
    <p>{{ error }}</p>
  {% endif %}
</div>
<script>
  function checkPlayer2() {
    const status = document.getElementById('join-status');
    status.style.color = '#777';
    status.textContent = 'Checking...';

    fetch('{{ url_for("has_player2_joined", game_id=game_id) }}')
      .then(res => res.json())
      .then(data => {
        if (data.joined) {
          let countdown = 3;
          status.style.color = 'green';
          status.textContent = `âœ… Player 2 has joined! Redirecting in ${countdown}...`;

          const interval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
              status.textContent = `âœ… Player 2 has joined! Redirecting in ${countdown}...`;
            } else {
              clearInterval(interval);
              window.location.href = '{{ url_for("game", game_id=game_id) }}';
            }
          }, 1000);
        } else {
          status.style.color = 'red';
          status.textContent = 'âŒ Player 2 has not joined yet.';
        }
      })
      .catch(err => {
        status.style.color = 'red';
        status.textContent = 'Error checking join status.';
      });
  }
</script>

{% endblock %}
